pipeline {
    agent any
    environment {
        SONAR_HOME = 'C:\\Users\\Administrator\\Desktop\\Narayanan-apps\\tools\\sonar-scanner-cli-7.1.0.4889-windows-x64\\sonar-scanner-7.1.0.4889-windows-x64\\bin'
        REPO_NAME='https://github.com/NarayananDurai07/html-sample-app.git'
        BRANCH_NAME ='master'
        SONAR_TOKEN= credentials('Narayanan_SQ_Token_Day3')
        SONAR_PROJECT_KEY =  'Narayanan_scan2'
        SONAR_SERVER_NAME = 'MYSQ_Server' // name we have configured under jenkins global confir
        DOCKER_CRED= 'narayanan_docker_hub'
    }

    stages {   
         // stage1
        stage('Hello') {
            steps {
                echo 'Hello World'
            }
        }    
        // stage to verify sonar-scanner 
        stage('sonar-scaner verify'){
             steps {
                echo 'checking version'
                // bat or pwsh
                //%SONAR_HOME%\\
                bat """
                C:\\Users\\Administrator\\Desktop\\Narayanan-apps\\tools\\sonar-scanner-cli-7.1.0.4889-windows-x64\\sonar-scanner-7.1.0.4889-windows-x64\\bin\\sonar-scanner --version
                docker version
                java --version 
                """
            }
         }
         stage("git checkout")
         {
            steps{
                echo 'Git checkout'
                git url: "${REPO_NAME}", branch: "${BRANCH_NAME}"
            }
         }
         stage('SAST'){
            steps{
                echo 'SAST'
                script {
                    withSonarQubeEnv("${SONAR_SERVER_NAME}") {
                
                    bat """
                    %SONAR_HOME%\\sonar-scanner \
                    -Dsonar.projectKey=${SONAR_PROJECT_KEY} \
                    -Dsonar.sources=. \
                    -Dsonar.host.url=${SONAR_HOST_URL} \
                    -Dsonar.token=${SONAR_TOKEN}
                    """

                    }                
                }
            }
         }
          // using docker plugin to build container image 
        stage('building docker image'){
            steps {
                echo 'starting docker build process'
                // to use docker plugin using script 
                script {
                    def imageName  = "docker.io/narann/narayananwebapp-iis-ltsc2022"
                    def imageTag   = "codev1"
                    docker.build("${imageName}:${imageTag}",".")

                }
                // verify image build 
                bat 'docker images   | findstr narayananwebapp'
            }               
            
        }
            stage('Trivy Scan for Zero Vulnerabilities') {
            steps {
                script {
                    // Execute Trivy scan and set exit code to 1 for any vulnerability
                    // --exit-code 1: Exits with a non-zero code if vulnerabilities are found, causing Jenkins to fail.
                    // --severity UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL: Includes all severity levels.
                    // --no-progress: Suppresses progress bar in output for cleaner logs.
                    // ${DOCKER_IMAGE_NAME}: Replace with your actual image name and tag
                    try {
                        sh "docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy image --exit-code 1 --severity UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL narann/hello-world:narayanv1"
                        echo "Trivy scan completed successfully with no vulnerabilities found."
                    } catch (Exception e) {
                        echo "Trivy scan found vulnerabilities. Build failing."
                        currentBuild.result = 'FAILURE'
                        throw e // Re-throw the exception to ensure the pipeline stage fails
                    }
                }
            }
        }
         stage('Pushing docker image'){
            steps{
                echo ' docker image'

                script{
                    def imageName = "narann/narayananwebapp-iis-ltsc2022"
                    def imageTag = "codev1"
                    def hubcred = "${DOCKER_CRED}"
                    // calling jenkins pluing docker pipeline to push
                    docker.withRegistry('https://registry.hub.docker.com',hubcred){
                        docker.image(imageName + ":" + imageTag).push()
                        // 
                    }
                    bat 'docker images | findstr narayananwebapp'
                }
            }
         }
    }
}